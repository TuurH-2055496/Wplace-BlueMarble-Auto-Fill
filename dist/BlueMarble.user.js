// ==UserScript==
// @name         Blue Marble
// @namespace    https://github.com/TuurH-2055496/
// @version      0.78.31
// @description  A userscript to automate and/or enhance the user experience on Wplace.live. Make sure to comply with the site's Terms of Service, and rules! This script is not affiliated with Wplace.live in any way, use at your own risk. This script is not affiliated with TamperMonkey. The author of this userscript is not responsible for any damages, issues, loss of data, or punishment that may occur as a result of using this script. This script is provided "as is" under the MPL-2.0 license. The "Blue Marble" icon is licensed under CC0 1.0 Universal (CC0 1.0) Public Domain Dedication. The image is owned by NASA.
// @author       SwingTheVine
// @license      MPL-2.0
// @supportURL   https://discord.gg/tpeBPy46hf
// @homepageURL  https://github.com/TuurH-2055496/Wplace-BlueMarble-Auto-Fill
// @icon         https://raw.githubusercontent.com/TuurH-2055496/Wplace-BlueMarble-Auto-Fill/refs/heads/main/dist/assets/Favicon.png
// @updateURL    https://raw.githubusercontent.com/TuurH-2055496/Wplace-BlueMarble-Auto-Fill/main/dist/BlueMarble.user.js
// @downloadURL  https://raw.githubusercontent.com/TuurH-2055496/Wplace-BlueMarble-Auto-Fill/main/dist/BlueMarble.user.js
// @run-at       document-start
// @match        https://*.wplace.live/*
// @connect      *
// @grant        GM_getResourceText
// @grant        GM_addStyle
// @grant        GM.setValue
// @grant        GM_getValue
// @resource     CSS-BM-File https://raw.githubusercontent.com/TuurH-2055496/Wplace-BlueMarble-Auto-Fill/refs/heads/main/dist/BlueMarble.user.css
// ==/UserScript==

// Wplace  --> https://wplace.live
// License --> https://www.mozilla.org/en-US/MPL/2.0/

(()=>{var e,t,n=e=>{throw TypeError(e)},o=(e,t,o)=>t.has(e)?n("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,o),i=(e,t,o)=>(((e,t)=>{t.has(e)||n("Cannot access private method")})(e,t),o),s=class{constructor(t,n){o(this,e),this.name=t,this.version=n,this.o=null,this.i="bm-b",this.l=null,this.u=null,this.m=[]}p(e){this.o=e}h(){return this.m.length>0&&(this.u=this.m.pop()),this}$(e){e?.appendChild(this.l),this.l=null,this.u=null,this.m=[]}T(n={},o=()=>{}){return o(this,i(this,e,t).call(this,"div",{},n)),this}v(n={},o=()=>{}){return o(this,i(this,e,t).call(this,"p",{},n)),this}O(n={},o=()=>{}){return o(this,i(this,e,t).call(this,"small",{},n)),this}M(n={},o=()=>{}){return o(this,i(this,e,t).call(this,"img",{},n)),this}L(n,o={},s=()=>{}){return s(this,i(this,e,t).call(this,"h"+n,{},o)),this}C(n={},o=()=>{}){return o(this,i(this,e,t).call(this,"hr",{},n)),this}k(n={},o=()=>{}){return o(this,i(this,e,t).call(this,"br",{},n)),this}A(n={},o=()=>{}){const s=i(this,e,t).call(this,"label",{textContent:n.textContent??""});delete n.textContent;const a=i(this,e,t).call(this,"input",{type:"checkbox"},n);return s.insertBefore(a,s.firstChild),this.h(),o(this,s,a),this}I(n={},o=()=>{}){return o(this,i(this,e,t).call(this,"button",{},n)),this}P(n={},o=()=>{}){const s=n.title??n.textContent??"Help: No info";delete n.textContent,n.title=`Help: ${s}`;const a={textContent:"?",className:"bm-q",onclick:()=>{this.F(this.i,s)}};return o(this,i(this,e,t).call(this,"button",a,n)),this}S(n={},o=()=>{}){return o(this,i(this,e,t).call(this,"input",{},n)),this}N(n={},o=()=>{}){const s=n.textContent??"";delete n.textContent;const a=i(this,e,t).call(this,"div"),c=i(this,e,t).call(this,"input",{type:"file",style:"display: none !important; visibility: hidden !important; position: absolute !important; left: -9999px !important; width: 0 !important; height: 0 !important; opacity: 0 !important;"},n);this.h();const r=i(this,e,t).call(this,"button",{textContent:s});return this.h(),this.h(),c.setAttribute("tabindex","-1"),c.setAttribute("aria-hidden","true"),r.addEventListener("click",()=>{c.click()}),c.addEventListener("change",()=>{r.style.maxWidth=`${r.offsetWidth}px`,c.files.length>0?r.textContent=c.files[0].name:r.textContent=s}),o(this,a,c,r),this}U(n={},o=()=>{}){return o(this,i(this,e,t).call(this,"textarea",{},n)),this}F(e,t,n=!1){const o=document.getElementById(e.replace(/^#/,""));o&&(o instanceof HTMLInputElement?o.value=t:n?o.textContent=t:o.innerHTML=t)}R(e,t){let n,o=!1,i=0,s=null,a=0,c=0,r=0,l=0;if(e=document.querySelector("#"==e?.[0]?e:"#"+e),t=document.querySelector("#"==t?.[0]?t:"#"+t),!e||!t)return void this.B(`Can not drag! ${e?"":"moveMe"} ${e||t?"":"and "}${t?"":"iMoveThings "}was not found!`);const u=()=>{if(o){const t=Math.abs(a-r),n=Math.abs(c-l);(t>.5||n>.5)&&(a=r,c=l,e.style.transform=`translate(${a}px, ${c}px)`,e.style.left="0px",e.style.top="0px",e.style.right=""),s=requestAnimationFrame(u)}};let d=null;const m=(m,p)=>{o=!0,d=e.getBoundingClientRect(),n=m-d.left,i=p-d.top;const h=window.getComputedStyle(e).transform;if(h&&"none"!==h){const e=new DOMMatrix(h);a=e.m41,c=e.m42}else a=d.left,c=d.top;r=a,l=c,document.body.style.userSelect="none",t.classList.add("dragging"),s&&cancelAnimationFrame(s),u()},p=()=>{o=!1,s&&(cancelAnimationFrame(s),s=null),document.body.style.userSelect="",t.classList.remove("dragging")};t.addEventListener("mousedown",function(e){e.preventDefault(),m(e.clientX,e.clientY)}),t.addEventListener("touchstart",function(e){const t=e?.touches?.[0];t&&(m(t.clientX,t.clientY),e.preventDefault())},{passive:!1}),document.addEventListener("mousemove",function(e){o&&d&&(r=e.clientX-n,l=e.clientY-i)},{passive:!0}),document.addEventListener("touchmove",function(e){if(o&&d){const t=e?.touches?.[0];if(!t)return;r=t.clientX-n,l=t.clientY-i,e.preventDefault()}},{passive:!1}),document.addEventListener("mouseup",p),document.addEventListener("touchend",p),document.addEventListener("touchcancel",p)}D(e){(0,console.info)(`${this.name}: ${e}`),this.F(this.i,"Status: "+e,!0)}B(e){(0,console.error)(`${this.name}: ${e}`),this.F(this.i,"Error: "+e,!0)}};function a(e,t){if(0===e)return t[0];let n="";const o=t.length;for(;e>0;)n=t[e%o]+n,e=Math.floor(e/o);return n}function c(e){let t="";for(let n=0;n<e.length;n++)t+=String.fromCharCode(e[n]);return btoa(t)}function r(e){const t=atob(e),n=new Uint8Array(t.length);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);return n}e=new WeakSet,t=function(e,t={},n={}){const o=document.createElement(e);this.l?(this.u?.appendChild(o),this.m.push(this.u),this.u=o):(this.l=o,this.u=o);for(const[e,n]of Object.entries(t))o[e]=n;for(const[e,t]of Object.entries(n))o[e]=t;return o};var l,u,d,m=class{constructor({displayName:e="My template",W:t=0,j:n="",url:o="",file:i=null,coords:s=null,J:a=null,G:c=1e3}={}){this.displayName=e,this.W=t,this.j=n,this.url=o,this.file=i,this.coords=s,this.J=a,this.G=c,this.q=0}async H(){console.log("Template coordinates:",this.coords);const e=await createImageBitmap(this.file),t=e.width,n=e.height;let o=0;console.log(`Template dimensions: ${t}×${n} = ${(t*n).toLocaleString()} total pixels`);const i={},s={},a=new OffscreenCanvas(this.G,this.G),r=a.getContext("2d",{_:!0}),l=new OffscreenCanvas(t,n).getContext("2d");l.drawImage(e,0,0);const u=l.getImageData(0,0,t,n);console.log("PERFORMANCE: Pre-extracted template image data for faster processing");for(let l=this.coords[3];l<n+this.coords[3];){const d=Math.min(this.G-l%this.G,n-(l-this.coords[3]));for(let m=this.coords[2];m<t+this.coords[2];){const p=Math.min(this.G-m%this.G,t-(m-this.coords[2])),h=3*p,f=3*d;a.width=h,a.height=f,r.imageSmoothingEnabled=!1,r.clearRect(0,0,h,f),r.drawImage(e,m-this.coords[2],l-this.coords[3],p,d,0,0,3*p,3*d);const b=r.getImageData(0,0,h,f);let w=0;for(let e=0;e<f;e++)for(let o=0;o<h;o++)if(o%3!=1||e%3!=1){const t=4*(e*h+o);b.data[t+3]=0}else{const i=Math.floor(o/3)+(m-this.coords[2]),s=Math.floor(e/3)+(l-this.coords[3]);if(i>=0&&i<t&&s>=0&&s<n){const e=4*(s*t+i);u.data[e+3]>0&&w++}}o+=w,r.putImageData(b,0,0);const g=`${(this.coords[0]+Math.floor(m/1e3)).toString().padStart(4,"0")},${(this.coords[1]+Math.floor(l/1e3)).toString().padStart(4,"0")},${(m%1e3).toString().padStart(3,"0")},${(l%1e3).toString().padStart(3,"0")}`;i[g]=await createImageBitmap(a);const $=await a.convertToBlob(),y=await $.arrayBuffer(),x=Array.from(new Uint8Array(y));s[g]=c(x),m+=p}l+=d}return this.q=o,console.log(`PERFORMANCE: Template processing complete - ${o.toLocaleString()} non-transparent pixels`),console.log("Template Tiles: ",i),console.log("Template Tiles Buffers: ",s),{Y:i,X:s}}};l=new WeakSet,u=async function(){GM.setValue("bmTemplates",JSON.stringify(this.K))},d=async function(e){console.log("Parsing BlueMarble...");const t=e.templates;if(console.log(`BlueMarble length: ${Object.keys(t).length}`),Object.keys(t).length>0)for(const e in t){const n=e,o=t[e];if(console.log(n),t.hasOwnProperty(e)){const e=n.split(" "),t=Number(e?.[0]),i=e?.[1]||"0",s=o.name||`Template ${t||""}`,a=o.tiles,c={};for(const e in a)if(console.log(e),a.hasOwnProperty(e)){const t=r(a[e]),n=new Blob([t],{type:"image/png"}),o=await createImageBitmap(n);c[e]=o}const l=new m({displayName:s,W:t||this.V?.length||0,j:i||""});l.J=c,this.V.push(l),console.log(this.V),console.log("^^^ This ^^^")}}};var p=GM_info.script.name.toString(),h=GM_info.script.version.toString();!function(e){const t=document.createElement("script");t.setAttribute("bm-r",p),t.setAttribute("bm-o","color: cornflowerblue;"),t.textContent=`(${e})();`,document.documentElement?.appendChild(t),t.remove()}(()=>{const e=document.currentScript,t=e?.getAttribute("bm-r")||"Blue Marble",n=e?.getAttribute("bm-o")||"",o=new Map;window.addEventListener("message",e=>{const{source:i,endpoint:s,blobID:a,blobData:c,blink:r}=e.data,l=Date.now()-r;if(console.groupCollapsed(`%c${t}%c: ${o.size} Recieved IMAGE message about blob "${a}"`,n,""),console.log(`Blob fetch took %c${String(Math.floor(l/6e4)).padStart(2,"0")}:${String(Math.floor(l/1e3)%60).padStart(2,"0")}.${String(l%1e3).padStart(3,"0")}%c MM:SS.mmm`,n,""),console.log(o),console.groupEnd(),"blue-marble"==i&&a&&c&&!s){const e=o.get(a);"function"==typeof e?e(c):function(...e){(0,console.warn)(...e)}(`%c${t}%c: Attempted to retrieve a blob (%s) from queue, but the blobID was not a function! Skipping...`,n,"",a),o.delete(a)}});const i=window.fetch;window.fetch=async function(...e){const s=(e[0]instanceof Request?e[0]?.url:e[0])||"ignore",a=(e[1],await i.apply(this,e)),c=a.clone(),r=s,l=c.headers.get("content-type")||"";if(l.includes("application/json"))console.log(`%c${t}%c: Sending JSON message about endpoint "${r}"`,n,""),c.json().then(e=>{window.postMessage({source:"blue-marble",endpoint:r,jsonData:e},"*")}).catch(e=>{console.error(`%c${t}%c: Failed to parse JSON: `,n,"",e)});else if(l.includes("image/")&&!r.includes("openfreemap")&&!r.includes("maps")){const e=Date.now(),i=await c.blob();return console.log(`%c${t}%c: ${o.size} Sending IMAGE message about endpoint "${r}"`,n,""),new Promise(s=>{const a=crypto.randomUUID();o.set(a,e=>{s(new Response(e,{headers:c.headers,status:c.status,statusText:c.statusText})),console.log(`%c${t}%c: ${o.size} Processed blob "${a}"`,n,"")}),window.postMessage({source:"blue-marble",endpoint:r,blobID:a,blobData:i,blink:e})}).catch(i=>{const s=Date.now();console.error(`%c${t}%c: Failed to Promise blob!`,n,""),console.groupCollapsed(`%c${t}%c: Details of failed blob Promise:`,n,""),console.log(`Endpoint: ${r}\nThere are ${o.size} blobs processing...\nBlink: ${e.toLocaleString()}\nTime Since Blink: ${String(Math.floor(s/6e4)).padStart(2,"0")}:${String(Math.floor(s/1e3)%60).padStart(2,"0")}.${String(s%1e3).padStart(3,"0")} MM:SS.mmm`),console.error("Exception stack:",i),console.groupEnd()})}return a}});var f=GM_getResourceText("CSS-BM-File");GM_addStyle(f);var b=document.createElement("link");b.href="https://fonts.googleapis.com/css2?family=Roboto+Mono:ital,wght@0,100..700;1,100..700&display=swap",b.rel="preload",b.as="style",b.onload=function(){this.onload=null,this.rel="stylesheet"},document.head?.appendChild(b),new class{constructor(){this.Z=null,this.ee=null,this.te="#bm-5"}ne(e){return this.ee=e,this.Z=new MutationObserver(e=>{for(const t of e)for(const e of t.addedNodes)e instanceof HTMLElement&&e.matches?.(this.te)}),this}oe(){return this.Z}observe(e,t=!1,n=!1){e.observe(this.ee,{childList:t,subtree:n})}};var w=new s(p,h),g=(new s(p,h),new class{constructor(e,t,n){o(this,l),this.name=e,this.version=t,this.l=n,this.ie="1.0.0",this.se=null,this.ae="!#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[]^_`abcdefghijklmnopqrstuvwxyz{|}~",this.G=1e3,this.ce=3,this.re=null,this.le=null,this.ue="bm-p",this.de="div#map canvas.maplibregl-canvas",this.me=null,this.pe="",this.V=[],this.K=null,this.he=!0}fe(){if(document.body.contains(this.re))return this.re;document.getElementById(this.ue)?.remove();const e=document.querySelector(this.de),t=document.createElement("canvas");return t.id=this.ue,t.className="maplibregl-canvas",t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.height=e?.clientHeight*(window.devicePixelRatio||1)+"px",t.style.width=e?.clientWidth*(window.devicePixelRatio||1)+"px",t.height=e?.clientHeight*(window.devicePixelRatio||1),t.width=e?.clientWidth*(window.devicePixelRatio||1),t.style.zIndex="8999",t.style.pointerEvents="none",e?.parentElement?.appendChild(t),this.re=t,window.addEventListener("move",this.be),window.addEventListener("zoom",this.we),window.addEventListener("resize",this.ge),this.re}async $e(){return{whoami:this.name.replace(" ",""),scriptVersion:this.version,schemaVersion:this.ie,templates:{}}}async ye(e,t,n){this.K||(this.K=await this.$e(),console.log("Creating JSON...")),this.l.D(`Creating template at ${n.join(", ")}...`);const o=new m({displayName:t,W:0,j:a(this.se||0,this.ae),file:e,coords:n}),{Y:s,X:c}=await o.H(this.G);o.J=s,this.K.templates[`${o.W} ${o.j}`]={name:o.displayName,coords:n.join(", "),enabled:!0,tiles:c},this.V=[],this.V.push(o);const r=(new Intl.NumberFormat).format(o.q);this.l.D(`Template created at ${n.join(", ")}! Total pixels: ${r}`),console.log(Object.keys(this.K.templates).length),console.log(this.K),console.log(this.V),console.log(JSON.stringify(this.K)),await i(this,l,u).call(this)}xe(){}async Te(){this.K||(this.K=await this.$e(),console.log("Creating JSON..."))}async ve(e,t){if(!this.he)return e;const n=this.G*this.ce;t=t[0].toString().padStart(4,"0")+","+t[1].toString().padStart(4,"0"),console.log(`Searching for templates in tile: "${t}"`);const o=this.V;console.log(o),o.sort((e,t)=>e.W-t.W),console.log(o);const i=o.map(e=>{const n=Object.keys(e.J).filter(e=>e.startsWith(t));if(0===n.length)return null;const o=n.map(t=>{const n=t.split(",");return{Oe:e.J[t],Me:[n[0],n[1]],Le:[n[2],n[3]]}});return o?.[0]}).filter(Boolean);console.log(i);const s=i?.length||0;if(console.log(`templateCount = ${s}`),s>0){const e=o.filter(e=>Object.keys(e.J).filter(e=>e.startsWith(t)).length>0).reduce((e,t)=>e+(t.q||0),0),n=(new Intl.NumberFormat).format(e);this.l.D(`Displaying ${s} template${1==s?"":"s"}.\nTotal pixels: ${n}`)}else this.l.D(`Displaying ${s} templates.`);const a=await createImageBitmap(e),c=new OffscreenCanvas(n,n),r=c.getContext("2d");r.imageSmoothingEnabled=!1,r.beginPath(),r.rect(0,0,n,n),r.clip(),r.clearRect(0,0,n,n),r.drawImage(a,0,0,n,n);for(const e of i)console.log("Template:"),console.log(e),r.drawImage(e.Oe,Number(e.Le[0])*this.ce,Number(e.Le[1])*this.ce);return await c.convertToBlob({type:"image/png"})}Ce(e){console.log("Importing JSON..."),console.log(e),"BlueMarble"==e?.whoami&&i(this,l,d).call(this,e)}ke(e){this.he=e}}(p,h,w)),$=new class{constructor(e){this.Ae=e,this.Ie=!1,this.Pe=[],this.Fe=[],this.droplets=0,this.charges=null,this.extraColorsBitmap=null}async Se(){try{const e=await fetch("https://backend.wplace.live/me",{credentials:"include"});if(e.ok){const t=await e.json();return console.log("ApiManager: Fetched fresh user data:",t),void 0!==t.extraColorsBitmap&&(this.extraColorsBitmap=t.extraColorsBitmap),void 0!==t.droplets&&(this.droplets=t.droplets),void 0!==t.charges&&(this.charges=t.charges),void 0!==t.id&&(this.Ae.se=t.id),t}return console.warn("ApiManager: Failed to fetch user data:",e.status),null}catch(e){return console.error("ApiManager: Error fetching user data:",e),null}}Ne(e){window.addEventListener("message",async t=>{const n=t.data,o=n.jsonData;if(!n||"blue-marble"!==n.source)return;if(!n.endpoint)return;const i=n.endpoint?.split("?")[0].split("/").filter(e=>e&&isNaN(Number(e))).filter(e=>e&&!e.includes(".")).pop();switch(console.log('%cBlue Marble%c: Recieved message about "%s"',"color: cornflowerblue;","",i),i){case"me":if(o.status&&"2"!=o.status?.toString()[0])return void e.B("You are not logged in!\nCould not fetch userdata.");const t=Math.ceil(Math.pow(Math.floor(o.level)*Math.pow(30,.65),1/.65)-o.pixelsPainted);console.log(o.id),(o.id||0===o.id)&&console.log(a(o.id,"!#$%&'()*+,-./0123456789:;<=>?@ABCDEFGHIJKLMNOPQRSTUVWXYZ[]^_`abcdefghijklmnopqrstuvwxyz{|}~")),this.Ae.se=o.id,this.droplets=o.droplets,this.charges=o.charges,this.extraColorsBitmap=o.extraColorsBitmap,e.F("bm-h",`Username: <b>${function(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}(o.name)}</b>`),e.F("bm-c",`Droplets: <b>${(new Intl.NumberFormat).format(o.droplets)}</b>`),e.F("bm-6",`Next level in <b>${(new Intl.NumberFormat).format(t)}</b> pixel${1==t?"":"s"}`);break;case"pixel":const i=n.endpoint.split("?")[0].split("/").filter(e=>e&&!isNaN(Number(e))),r=new URLSearchParams(n.endpoint.split("?")[1]),l=[r.get("x"),r.get("y")];if(this.Pe.length&&(!i.length||!l.length))return void e.B("Coordinates are malformed!\nDid you try clicking the canvas first?");this.Pe=[...i,...l];const u=(s=i,c=l,[parseInt(s[0])%4*1e3+parseInt(c[0]),parseInt(s[1])%4*1e3+parseInt(c[1])]),d=document.querySelectorAll("span");for(const e of d)if(e.textContent.trim().includes(`${u[0]}, ${u[1]}`)){let t=document.querySelector("#bm-5");const n=`(Tl X: ${i[0]}, Tl Y: ${i[1]}, Px X: ${l[0]}, Px Y: ${l[1]})`;t?t.textContent=n:(t=document.createElement("span"),t.id="bm-5",t.textContent=n,t.style="margin-left: calc(var(--spacing)*3); font-size: small;",e.parentNode.parentNode.parentNode.insertAdjacentElement("afterend",t))}break;case"tiles":let m=n.endpoint.split("/");m=[parseInt(m[m.length-2]),parseInt(m[m.length-1].replace(".png",""))];const p=n.blobID,h=n.blobData,f=await this.Ae.ve(h,m);window.postMessage({source:"blue-marble",blobID:p,blobData:f,blink:n.blink});break;case"robots":this.Ie="false"==o.userscript?.toString().toLowerCase();break}var s,c})}}(g);w.p($);var y=JSON.parse(GM_getValue("bmTemplates","{}"));console.log(y),g.Ce(y),function(){let e=!1;w.T({id:"bm-n",style:"top: 10px; right: 75px;"}).T({id:"bm-7"}).T({id:"bm-i"}).h().M({alt:"Blue Marble Icon - Click to minimize/maximize",src:"https://raw.githubusercontent.com/SwingTheVine/Wplace-BlueMarble/main/dist/assets/Favicon.png",style:"cursor: pointer;"},(t,n)=>{n.addEventListener("click",()=>{e=!e;const o=document.querySelector("#bm-n"),i=document.querySelector("#bm-7"),s=document.querySelector("#bm-i"),a=document.querySelector("#bm-8"),c=document.querySelector("#bm-d"),r=document.querySelector("#bm-e"),l=document.querySelector("#bm-f"),u=document.querySelector("#bm-9"),d=document.querySelectorAll("#bm-8 input");e||(o.style.width="auto",o.style.maxWidth="300px",o.style.minWidth="200px",o.style.padding="10px"),["#bm-n h1","#bm-4","#bm-n hr","#bm-3 > *:not(#bm-8)","#bm-2","#bm-1",`#${t.i}`,"#bm-B","#bm-A","#bm-x"].forEach(t=>{document.querySelectorAll(t).forEach(t=>{t.style.display=e?"none":""})}),e?(a&&(a.style.display="none"),c&&(c.style.display="none"),r&&(r.style.display="none"),l&&(l.style.display="none"),u&&(u.style.display="none"),d.forEach(e=>{e.style.display="none"}),o.style.width="60px",o.style.height="76px",o.style.maxWidth="60px",o.style.minWidth="60px",o.style.padding="8px",n.style.marginLeft="3px",i.style.textAlign="center",i.style.margin="0",i.style.marginBottom="0",s&&(s.style.display="",s.style.marginBottom="0.25em")):(a&&(a.style.display="",a.style.flexDirection="",a.style.justifyContent="",a.style.alignItems="",a.style.gap="",a.style.textAlign="",a.style.margin=""),c&&(c.style.display=""),r&&(r.style.display="",r.style.marginTop=""),l&&(l.style.display="",l.style.marginTop=""),u&&(u.style.display="",u.style.marginTop=""),d.forEach(e=>{e.style.display=""}),n.style.marginLeft="",o.style.padding="10px",i.style.textAlign="",i.style.margin="",i.style.marginBottom="",s&&(s.style.marginBottom="0.5em"),o.style.width="",o.style.height=""),n.alt=e?"Blue Marble Icon - Minimized (Click to maximize)":"Blue Marble Icon - Maximized (Click to minimize)"})}).h().L(1,{textContent:p}).h().h().C().h().T({id:"bm-4"}).v({id:"bm-h",textContent:"Username:"}).h().v({id:"bm-c",textContent:"Droplets:"}).h().v({id:"bm-6",textContent:"Next level in..."}).h().h().C().h().T({id:"bm-3"}).T({id:"bm-8"}).I({id:"bm-d",className:"bm-q",style:"margin-top: 0;",innerHTML:'<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 6"><circle cx="2" cy="2" r="2"></circle><path d="M2 6 L3.7 3 L0.3 3 Z"></path><circle cx="2" cy="2" r="0.7" fill="white"></circle></svg></svg>'},(e,t)=>{t.onclick=()=>{const t=e.o?.Pe;t?.[0]?(e.F("bm-j",t?.[0]||""),e.F("bm-k",t?.[1]||""),e.F("bm-l",t?.[2]||""),e.F("bm-m",t?.[3]||"")):e.B("Coordinates are malformed! Did you try clicking on the canvas first?")}}).h().S({type:"number",id:"bm-j",placeholder:"Tl X",min:0,max:2047,step:1,required:!0}).h().S({type:"number",id:"bm-k",placeholder:"Tl Y",min:0,max:2047,step:1,required:!0}).h().S({type:"number",id:"bm-l",placeholder:"Px X",min:0,max:2047,step:1,required:!0}).h().S({type:"number",id:"bm-m",placeholder:"Px Y",min:0,max:2047,step:1,required:!0}).h().h().N({id:"bm-2",textContent:"Upload Template",accept:"image/png, image/jpeg, image/webp, image/bmp, image/gif"}).h().T({id:"bm-0"}).I({id:"bm-f",textContent:"Enable"},(e,t)=>{t.onclick=()=>{e.o?.Ae?.ke(!0),e.D("Enabled templates!");const t=document.querySelector("#bm-C"),n=document.querySelector("#bm-R"),o=document.querySelector("#bm-J"),i=document.querySelector("#bm-D"),s=document.querySelector("#bm-Q");e.o?.Ae?.V.length&&e.o?.Ae?.he&&(t&&(t.disabled=!1),n&&(n.disabled=!1),o&&(o.disabled=!1),i&&(i.disabled=!1),s&&(s.disabled=!1))}}).h().I({id:"bm-e",textContent:"Create"},(e,t)=>{t.onclick=async()=>{const t=document.querySelector("#bm-2"),n=document.querySelector("#bm-j");if(!n.checkValidity())return n.reportValidity(),void e.B("Coordinates are malformed! Did you try clicking on the canvas first?");const o=document.querySelector("#bm-k");if(!o.checkValidity())return o.reportValidity(),void e.B("Coordinates are malformed! Did you try clicking on the canvas first?");const i=document.querySelector("#bm-l");if(!i.checkValidity())return i.reportValidity(),void e.B("Coordinates are malformed! Did you try clicking on the canvas first?");const s=document.querySelector("#bm-m");if(!s.checkValidity())return s.reportValidity(),void e.B("Coordinates are malformed! Did you try clicking on the canvas first?");t?.files[0]?(templateAnalysisCache=null,templateAnalysisCacheKey=null,console.log("PERFORMANCE: Template cache cleared for new template"),await g.ye(t.files[0],t.files[0]?.name.replace(/\.[^/.]+$/,""),[Number(n.value),Number(o.value),Number(i.value),Number(s.value)]),e.D("Drew to canvas!")):e.B("No file selected!")}}).h().I({id:"bm-9",textContent:"Disable"},(e,t)=>{t.onclick=()=>{e.o?.Ae?.ke(!1),e.D("Disabled templates!"),templateAnalysisCache=null,templateAnalysisCacheKey=null,performanceMetrics={Ue:0,Ee:0,Re:0},console.log("PERFORMANCE: Template cache cleared (templates disabled)");const t=document.querySelector("#bm-C"),n=document.querySelector("#bm-R"),o=document.querySelector("#bm-J"),i=document.querySelector("#bm-D"),s=document.querySelector("#bm-Q");t&&(t.disabled=!0),n&&(n.disabled=!0),o&&(o.disabled=!0),i&&(i.disabled=!0),s&&(s.disabled=!0)}}).h().I({id:"bm-Q",textContent:"Sleep Mode: Off",disabled:!0},(e,t)=>{let n=!1;t.onclick=()=>{n=!n,window.bmSleepMode=n,t.textContent="Sleep Mode: "+(n?"On":"Off"),e.D("💤 Sleep mode "+(n?"enabled":"disabled"))}}).h().I({id:"bm-C",textContent:"Auto Fill",disabled:!0},(e,t)=>{let n=!1;const o=new Set,i=e=>new Promise(t=>setTimeout(t,e)),s={0:[0,0,0,0],1:[0,0,0,255],2:[60,60,60,255],3:[120,120,120,255],4:[210,210,210,255],5:[255,255,255,255],6:[96,0,24,255],7:[237,28,36,255],8:[255,127,39,255],9:[246,170,9,255],10:[249,221,59,255],11:[255,250,188,255],12:[14,185,104,255],13:[19,230,123,255],14:[135,255,94,255],15:[12,129,110,255],16:[16,174,166,255],17:[19,225,190,255],18:[40,80,158,255],19:[64,147,228,255],20:[96,247,242,255],21:[107,80,246,255],22:[153,177,251,255],23:[120,12,153,255],24:[170,56,185,255],25:[224,159,249,255],26:[203,0,122,255],27:[236,31,128,255],28:[243,141,169,255],29:[104,70,52,255],30:[149,104,42,255],31:[248,178,119,255],32:[170,170,170,255],33:[165,14,30,255],34:[250,128,114,255],35:[228,92,26,255],36:[214,181,148,255],37:[156,132,49,255],38:[197,173,49,255],39:[232,212,95,255],40:[74,107,58,255],41:[90,148,74,255],42:[132,197,115,255],43:[15,121,159,255],44:[187,250,242,255],45:[125,199,255,255],46:[77,49,184,255],47:[74,66,132,255],48:[122,113,196,255],49:[181,174,241,255],50:[219,164,99,255],51:[209,128,81,255],52:[255,197,165,255],53:[155,82,73,255],54:[209,128,120,255],55:[250,182,164,255],56:[123,99,82,255],57:[156,132,107,255],58:[51,57,65,255],59:[109,117,141,255],60:[179,185,209,255],61:[109,100,63,255],62:[148,140,107,255],63:[205,197,158,255]},a=e=>{const t=Math.floor(e/3600),n=Math.floor(e%3600/60),o=Math.floor(e%60);return`${t.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`},c=e=>{const t=document.querySelector("#bm-B");if(t){const n=`[${(new Date).toLocaleTimeString()}] ${e}`;t.value=n+"\n";const o=t.value.split("\n");o.length>20&&(t.value=o.slice(0,20).join("\n")),t.scrollTop=0}},r=e=>{const t=document.querySelector("#bm-A"),n=30*e;if(t){let o=`Remaining Pixels: ${e.toLocaleString()}`;o+=null!==n&&n>0?`\nEstimated Time: ${a(n)}`:"\nEstimated Time: N/A",t.value=o}},l=async(e,t={})=>{const{Be:n=100,De:o=!1,We:s=200,ze:a="AUTOFILL",description:r="element",je:l=""}=t;let u=document.querySelector(e),d=0;for(console.log(`${a}: Looking for ${r}${l}...`),c(`🔍 Looking for ${r}${l}...`);(!u||o&&u.disabled)&&d<n;){d++;const t=`${a}: Waiting for ${r} to be ready${l}... (${d}s/${n}s)`;console.log(t),c(`⏳ Waiting for ${r} to be ready${l}... (${d}s/${n}s)`),await i(s),u=document.querySelector(e)}return u?o&&u.disabled?(c(`❌ ${r} still disabled after waiting${l}`),console.error(`${a}: ${r} still disabled after waiting${l}`),{Je:!1,element:u,reason:"disabled"}):(c(`✅ ${r} is ready${l}`),console.log(`${a}: ${r} is ready${l}`),{Je:!0,element:u,reason:"ready"}):(c(`❌ ${r} not found after waiting${l}`),console.error(`${a}: ${r} not found after waiting${l}`),{Je:!1,element:null,reason:"not_found"})};function u(e){const t=[];for(let e=0;e<=31;e++)t.push(e);if(e&&e>0)for(let n=32;n<64;n++)e&1<<n-32&&t.push(n);return t.sort((e,t)=>e-t)}const d=(e,t,n,o)=>{if(0===o)return 0;let i=1/0,a=1;for(const[o,[c,r,l]]of Object.entries(s)){if("0"===o)continue;const s=Math.sqrt((e-c)**2+(t-r)**2+(n-l)**2);s<i&&(i=s,a=parseInt(o))}return a},m=async(e,t)=>{try{const n=await fetch(`https://backend.wplace.live/files/s0/tiles/${e}/${t}.png`);if(!n.ok)return console.log(`Chunk ${e},${t} not found or empty`),null;const o=await n.blob();return await createImageBitmap(o)}catch(n){return console.warn(`Failed to fetch chunk ${e},${t}:`,n),null}},p=()=>{const e=document.querySelector("#bm-x");if(e){const t=b.Ee+b.Re>0?(b.Ee/(b.Ee+b.Re)*100).toFixed(1):"0.0",n=`Performance Metrics:\nCache: ${b.Ee} hits, ${b.Re} misses (${t}% hit rate)\nLast analysis: ${b.Ue.toFixed(2)}ms\nMemory: Template analysis ${h?"cached":"not cached"}`;e.value=n}};let h=null,f=null,b={Ue:0,Ee:0,Re:0};const w=async(t,n=[])=>{const i=performance.now(),s={};if(!e.o?.Ae?.V?.length)return[];const a=e.o.Ae.V[0].J;if(!a)return e.B("Template has no pixel data (chunked property is missing)."),[];const r=`${Object.keys(a).length}_${n.join(",")}`,l=new Set(n);if(h&&f===r){b.Ee++;const e=performance.now()-i;console.log(`PERFORMANCE: Using cached template analysis (${e.toFixed(2)}ms) - Cache hits: ${b.Ee}`),c(`⚡ Cache hit! Analysis completed in ${e.toFixed(2)}ms (${b.Ee} hits)`),p()}else{b.Re++;const e=performance.now();console.log(`PERFORMANCE: Analyzing template (cache miss ${b.Re}) - this may take a moment for large templates`),c("🔍 Analyzing template structure...");const t=Object.keys(a).sort(),o=new Set,i=new Map;let s=0;for(const r of t){const u=a[r];if(!u)continue;if(s++,s%10==0){const n=performance.now()-e;console.log(`PERFORMANCE: Processed ${s}/${t.length} chunks in ${n.toFixed(2)}ms`),c(`⚡ Analyzing chunk ${s}/${t.length} (${n.toFixed(2)}ms)...`),await new Promise(e=>setTimeout(e,1))}const m=r.split(",").map(Number),[p,h,f,b]=m;let w;if(i.has(r))w=i.get(r);else{const e=new OffscreenCanvas(u.width,u.height).getContext("2d");e.drawImage(u,0,0),w=e.getImageData(0,0,u.width,u.height),i.set(r,w)}const g=[];for(let e=1;e<u.height;e+=3)for(let t=1;t<u.width;t+=3){const i=4*(e*u.width+t),s=w.data[i+3];if(0===s)continue;const a=w.data[i],c=w.data[i+1],r=w.data[i+2],m=d(a,c,r,s),$=f+Math.floor((t-1)/3),y=b+Math.floor((e-1)/3),x=`${p},${h},${$},${y}`;o.add(x),g.push({Ge:p,qe:h,He:$,_e:y,Ye:m,Xe:x,Ke:0===n.length||l.has(m)})}i.set(`${r}_pixels`,g)}console.log("PERFORMANCE: Computing border detection during template analysis"),c("🔍 Analyzing border pixels (pixels next to transparent areas)...");const u=[[-1,-1],[0,-1],[1,-1],[-1,0],[1,0],[-1,1],[0,1],[1,1]],m=new Set;for(const e of o){const[t,n,o,i]=e.split(",").map(Number),s=1e3*t+o,a=1e3*n+i;m.add(`${s},${a}`)}const w=new Set;let g=0;for(const e of o){const[t,n,i,s]=e.split(",").map(Number),a=1e3*t+i,r=1e3*n+s;let l=!1;for(const[e,t]of u){const n=`${a+e},${r+t}`;if(!m.has(n)){l=!0;break}}l&&w.add(e),g++,g%25e3==0&&(c(`⚡ Border analysis progress: ${g}/${o.size}...`),await new Promise(e=>setTimeout(e,1)))}console.log(`BORDER: Analyzed ${o.size} pixels, found ${w.size} border pixels`),c(`✅ Border analysis complete: ${w.size} border pixels identified`),h={Ve:o,Ze:i,Qe:t,et:w},f=r,b.Ue=performance.now()-e,console.log(`PERFORMANCE: Template analysis complete and cached in ${b.Ue.toFixed(2)}ms`),c(`✅ Template analysis complete (${b.Ue.toFixed(2)}ms) and cached for future use!`),p()}const{Ve:u,Ze:w,Qe:g}=h,$=new Map;console.log("CACHE: Using fresh chunk cache for server state - protection mode will detect all changes");const y=[];let x=0;for(const e of g){const t=w.get(`${e}_pixels`);if(!t)continue;const n=t.filter(e=>e.Ke);if(0===n.length)continue;x++,x%5==0&&(c(`🔍 Checking current state ${x} chunks...`),await new Promise(e=>setTimeout(e,1)));const i=e.split(",").map(Number),[s,a]=i,r=`${s},${a}`;if($.has(r),1){const e=await m(s,a);$.set(r,e)}const l=$.get(r);let u=null;if(l){const e=new OffscreenCanvas(l.width,l.height).getContext("2d");e.drawImage(l,0,0),u=e.getImageData(0,0,l.width,l.height)}for(const e of n){let t=!0;if(u&&e.He>=0&&e.He<u.width&&e._e>=0&&e._e<u.height){const n=4*(e._e*u.width+e.He),o=u.data[n],i=u.data[n+1],s=u.data[n+2],a=u.data[n+3];d(o,i,s,a)===e.Ye&&(t=!1)}t&&!o.has(e.Xe)&&y.push(e)}}const T=document.querySelector("#bm-R"),v=T?T.textContent.replace("Mode: ",""):"Border→Random";c("🎯 Using cached border analysis for optimal placement order..."),console.log("getNextPixels: Using cached border detection results");let O=[],M=[];const L=h.et;for(const e of y){const t=`${e.Ge},${e.qe},${e.He},${e._e}`;L.has(t)?O.push(e):M.push(e)}console.log(`getNextPixels: Using cached results - ${O.length} border pixels, ${M.length} interior pixels`),c(`✅ Border placement strategy: ${O.length} border pixels first, then ${M.length} interior pixels`),console.log(`DEBUG: Total pixels to place: ${y.length}, Border: ${O.length}, Interior: ${M.length}`);let C=[];if("Border→Scan"===v){const e=e=>e.sort((e,t)=>{const n=1e3*e.qe+e._e,o=1e3*t.qe+t._e,i=1e3*e.Ge+e.He,s=1e3*t.Ge+t.He;return n!==o?n-o:i-s});C=[...e([...O]),...e([...M])],console.log(`📏 Border→Scan mode: ${O.length} border + ${M.length} interior pixels in scan order`),c(`📏 Border→Scan: Border first (${O.length} pixels), then interior`)}else{const e=e=>{const t=[...e];for(let e=t.length-1;e>0;e--){const n=Math.floor(Math.random()*(e+1));[t[e],t[n]]=[t[n],t[e]]}return t};C=[...e(O),...e(M)],console.log(`🎲 Border→Random mode: ${O.length} border + ${M.length} interior pixels (randomized within groups)`),c(`🎲 Border→Random: Border first (${O.length} pixels), then interior (randomized)`)}let k=0;for(const e of C){if(k>=t)break;const n=`${e.Ge},${e.qe}`;s[n]||(s[n]={tt:[e.Ge,e.qe],nt:[]}),s[n].nt.push([e.He,e._e,e.Ye]),k++}return console.log(`\n📊 SUMMARY: Found ${y.length} total pixels that need placement (filtered by ${n.length} owned colors), returning ${k} pixels (${O.length} border priority)`),{ot:Object.values(s).map(e=>[e.tt,e.nt]),it:y.length}},g=async(e,t,n=0)=>{if(!t||0===t.length)return;const[o,s]=e,a=(e,n,i)=>({st:{colors:t.map(([,,e])=>e),coords:t.flatMap(([e,t])=>[e,t]),t:n},ct:`https://backend.wplace.live/s0/pixel/${o}/${s}`}),r=async()=>{const e=document.querySelector(".maplibregl-canvas");if(!e)throw new Error("Could not find the map canvas.");const t=window.innerWidth/2,n=window.innerHeight/2,o=["mousedown","click","mouseup"];for(const s of o){const o=new MouseEvent(s,{clientX:t,clientY:n,bubbles:!0});e.dispatchEvent(o),await i(50)}console.log("AUTOFILL: Starting...");const s=await l(".btn.btn-primary.btn-lg.sm\\:btn-xl.relative",{Be:100,De:!0,We:200,ze:"AUTOFILL",description:"final pixel placement button",je:""});if(!s.Je)throw new Error(`Could not find or enable final paint button: ${s.reason}`);console.log("AUTOFILL: Final button is ready - clicking now"),s.element.click()};try{const i=await(async(e,t,n="REQUEST")=>{const o=unsafeWindow.fetch;let i=!0;return new Promise(async(s,a)=>{unsafeWindow.fetch=async(...t)=>{const c=t[0],r=t[1]||{},l=(r.method||"GET").toUpperCase();if(!i)return o.apply(unsafeWindow,t);if("POST"!==l||"string"!=typeof c||!c.includes("/pixel/"))return o.apply(unsafeWindow,t);try{console.log(`${n}: Intercepting fetch request`);const t=JSON.parse(r.body),a=t.t;if(!a)throw new Error("Could not find security token 't'");const{st:l,ct:u}=e(t,a,c),d={...r,body:JSON.stringify(l)};i=!1,unsafeWindow.fetch=o,console.log(`${n}: Sending modified request`);const m=await o.call(unsafeWindow,u||c,d);return s(m),m}catch(e){i=!1,unsafeWindow.fetch=o,console.error(`${n}: Error during interception:`,e),a(e)}};try{await t()}catch(e){unsafeWindow.fetch=o,a(e)}})})(a,r,"AUTOFILL");return 429===i.status?(console.log(`Rate limited (429) on chunk ${o},${s}. Waiting 30s before retry...`),c(`⏰ Rate limited! Waiting 30s before retry (attempt ${n+1})...`),await new Promise(e=>setTimeout(e,3e4)),c(`🔄 Retrying pixel placement for chunk ${o},${s}...`),await g(e,t,n+1)):i}catch(e){throw e}};window.bmPlaceNow=async()=>{try{if(!n)return void c("⚠️ Auto-fill is not running. Start it first to use Place Now.");if(!e.o?.Ae?.V.length||!e.o?.Ae?.he)return void c("❌ No active template available for placement");const t=e.o?.charges;if(!t||Math.floor(t.count)<1)return void c("⚠️ No charges available to place now");const s=u(e.o?.extraColorsBitmap||0);if(!s.length)return void c("❌ No owned colors found");const a=await w(Math.floor(t.count),s),r=a?.ot||[];if(!r.length)return void c("✅ No pixels to place right now");const d=await l(".btn.btn-primary.btn-lg.sm\\:btn-xl.relative.z-30",{Be:100,De:!0,We:200,ze:"PLACENOW",description:"paint mode button",je:""});if(!d.Je)return void c("❌ Place Now: paint button not found");d.element.click(),c("✅ Place Now: opened paint menu"),await i(500);const m=r.reduce((e,t)=>e+t[1].length,0);c(`🎯 Place Now: placing ${m} pixels across ${r.length} chunks`);for(let e=0;e<r.length&&n;e++){const[t,n]=r[e],[s,a]=t;if(e>0){const t=await l(".btn.btn-primary.btn-lg.sm\\:btn-xl.relative.z-30",{Be:100,De:!1,We:200,ze:"PLACENOW",description:"paint button",je:` for chunk ${e+1}`});t.Je&&(t.element.click(),await i(200))}await g(t,n),await i(500),n.forEach(([e,t])=>o.add(`${s},${a},${e},${t}`)),c(`✅ Place Now: placed ${n.length} in chunk (${s},${a})`)}c("🎉 Place Now: batch complete")}catch(e){console.error("Place Now error:",e),c(`❌ Place Now error: ${e.message}`)}},t.onclick=async()=>{if(n)return console.log("AUTOFILL: User requested stop"),n=!1,t.textContent="Auto Fill",void c("⏹️ Auto-fill stopped by user");if(!e.o?.Ae?.V.length||!e.o?.Ae?.he)return console.log("AUTOFILL: No active template available"),void c("❌ No active template available");try{await e.o.Se()?console.log("Fetched fresh user data for auto-fill"):console.warn("Failed to fetch fresh user data, continuing with cached data")}catch(e){console.error("Error fetching fresh user data:",e)}for(console.log("AUTOFILL: Starting auto fill process"),n=!0,t.textContent="Stop Fill",c("🚀 Auto-fill started!");n;)try{console.log("AUTOFILL: Starting new cycle");const s=e.o?.charges;if(!s){console.log("AUTOFILL: No charge data available, waiting..."),c("⏳ Waiting for charge data..."),await i(5e3);continue}const d=await w(1,u(e.o?.extraColorsBitmap||0));if(console.log(`AUTOFILL: Progress result: ${JSON.stringify(d)}`),console.log(`AUTOFILL: Found ${d.it} chunk groups to process`),0===d.it){if(console.log("AUTOFILL: Template completed - no more pixels to place"),console.log("AUTOFILL: Closing Paint Menu"),c("🎨 Closing Paint Menu..."),c("🎉 Template completed! All owned color pixels placed."),r(0),window.bmProtectMode){for(console.log("AUTOFILL: Transitioning to protection mode - monitoring"),c("🛡️ Protection mode active - monitoring template for damage");n&&window.bmProtectMode;)try{if(console.log("PROTECT: Checking template integrity..."),c("🔍 Checking template integrity..."),await i(1e4),!n||!window.bmProtectMode){console.log("PROTECT: Protection mode disabled or auto-fill stopped");break}const t=u(e.o?.extraColorsBitmap||0);if(0===t.length){console.log("PROTECT: No owned colors found, skipping check");continue}const o=await w(0,t);if(o.it>0){console.log(`PROTECT: Found ${o.it} pixels that need protection!`),c(`🚨 Protection alert: ${o.it} pixels need fixing!`);const t=e.o?.charges;if(t&&Math.floor(t.count)>0){const e=Math.min(Math.floor(t.count),o.it);console.log(`PROTECT: Attempting to fix ${e} pixels with ${Math.floor(t.count)} charges`),c(`🔧 Fixing ${e} pixels with available charges...`),c("🛡️ Protection mode: Restarting placement cycle to fix damaged pixels");break}console.log("PROTECT: No charges available for immediate fixing"),c("⚠️ Damage detected but no charges available for fixing")}else console.log("PROTECT: Template is intact"),c("✅ Template protection check: All pixels intact")}catch(e){console.error("PROTECT: Error during protection check:",e),c(`❌ Protection error: ${e.message}`)}if(n&&window.bmProtectMode){console.log("PROTECT: Damage detected, continuing with auto-fill cycle");continue}console.log("AUTOFILL: Protection disabled or stopped, exiting");break}t.textContent="Auto Fill",n=!1;break}if(r(d.it),console.log(`AUTOFILL: Current charges: ${s.count}/${s.max}`),s.count<s.max&&d.it>Math.floor(s.count)){console.log(`AUTOFILL: Charges not full (${s.count}/${s.max}) and remaining pixels (${d.it}) > available charges (${Math.floor(s.count)}), refreshing user data`),c("🔄 Refreshing user data for latest charges..."),await e.o.Se();const t=e.o?.charges;if(t&&t.count>=t.max){console.log("AUTOFILL: Charges are now full after refresh, proceeding"),c("✅ Charges are now full after refresh!");continue}console.log("AUTOFILL: Still need to wait for charges, calculating wait time");const o=s.max-Math.floor(s.count),r=s.count-Math.floor(s.count),l=s.rt||3e4,u=Math.ceil((1-r)*l)+(o-1)*l;if(console.log(`AUTOFILL: Waiting ${(u/1e3).toFixed(1)}s for ${o} charges`),c(`⏱️ Precise timing: ${s.count.toFixed(3)}/${s.max} charges, waiting ${a(u/1e3)}`),window.bmSleepMode)c(`💤 Sleep mode: pausing for ${a(u/1e3)} until enough charges`),await i(u);else{const t=Date.now()+u;let o=0;for(;Date.now()<t&&n;){const n=Math.max(0,t-Date.now());if(o++,o%10==0){console.log(`AUTOFILL: 10 seconds elapsed (iteration ${o}), refreshing user data`),c(`🔄 ${o}s elapsed - checking charges via data refresh`),await e.o.Se();const t=e.o?.charges;if(t&&t.count>=t.max){console.log("AUTOFILL: Charges are now full after refresh, breaking wait loop"),c("✅ Charges full after refresh - proceeding immediately!");break}console.log(`AUTOFILL: After refresh - charges: ${t?.count.toFixed(3)}/${t?.max}, continuing wait`),c(`📊 Refresh result: ${t?.count.toFixed(3)}/${t?.max} charges, continuing wait`)}const s=a(n/1e3);c(`⏳ Charging ${s} remaining`),await i(Math.min(1e3,n))}}if(!n){console.log("AUTOFILL: Stopped during charge wait");break}console.log("AUTOFILL: Charge wait completed, continuing");continue}s.count<s.max&&(console.log(`AUTOFILL: Charges not full (${s.count}/${s.max}) but sufficient for remaining pixels (${d.it}), proceeding with pixel placement`),c(`⚡ Sufficient charges (${Math.floor(s.count)}) for remaining pixels (${d.it}), proceeding!`)),console.log("AUTOFILL: Proceeding with pixel placement"),console.log("AUTOFILL: Getting owned colors from extraColorsBitmap..."),c("🔍 Getting owned colors from bitmap...");const m=e.o?.extraColorsBitmap||0,p=u(m);if(console.log(`AUTOFILL: Found ${p.length} owned colors from bitmap ${m}`),0===p.length){console.log("AUTOFILL: No owned colors found from bitmap, retrying in 10s"),c("❌ No owned colors found from bitmap! Retrying in 10s..."),await i(1e4);continue}console.log(`AUTOFILL: Looking for up to ${s.count} pixels to place`),c(`⚡ Charges available (${s.count}/${s.max}). Finding up to ${s.count} pixels from ${p.length} owned colors...`);const h=(await w(s.count,p)).ot;if(console.log(`AUTOFILL: Found ${h.length} chunk groups to process`),0===d.it){console.log("AUTOFILL: Template completed - no more pixels to place"),console.log("AUTOFILL: Closing Paint Menu"),c("🎨 Closing Paint Menu...");const e=document.querySelector(".relative.px-3"),o=e.querySelector('.btn.btn-circle.btn-sm svg path[d="m256-200-56-56 224-224-224-224 56-56 224 224 224-224 56 56-224 224 224 224-56 56-224-224-224 224Z"]')?.closest("button");o&&o.click(),n=!1,window.bmProtectMode?t.textContent="Stop Fill":t.textContent="Auto Fill",c("🎉 Template completed! All owned color pixels placed."),r(0);break}const f=await l(".btn.btn-primary.btn-lg.sm\\:btn-xl.relative.z-30",{Be:100,De:!0,We:200,ze:"AUTOFILL",description:"paint mode button",je:""});if(!f.Je){await i(5e3);continue}f.element.click(),c("✅ Clicked paint mode button"),console.log("Clicked paint mode button"),await i(500);const b=h.reduce((e,t)=>e+t[1].length,0);console.log(`AUTOFILL: Will place ${b} pixels across ${h.length} chunks`),c(`🎯 Found ${b} pixels to place in ${h.length} chunks`);for(let e=0;e<h.length;e++){if(!n){console.log("AUTOFILL: Stopped during chunk processing");break}const t=h[e],[s,a]=t,[r,u]=s;if(console.log(`AUTOFILL: ChunkIndex: ${e}`),e>0){console.log(`AUTOFILL: Reopening paint menu for chunk ${e+1}/${h.length}`),c(`🎨 Reopening paint menu for chunk ${e+1}...`);const t=await l(".btn.btn-primary.btn-lg.sm\\:btn-xl.relative.z-30",{Be:100,De:!1,We:200,ze:"AUTOFILL",description:"paint button",je:` for chunk ${e+1}`});if(!t.Je){console.error(`AUTOFILL: Could not find paint button for chunk ${e+1}, skipping chunk`),c(`❌ Could not find paint button for chunk ${e+1}, skipping`);continue}t.element.click(),c(`✅ Paint menu reopened for chunk ${e+1}`),await i(200)}console.log(`AUTOFILL: Processing chunk ${r},${u} with ${a.length} pixels`),c(`🔄 Placing ${a.length} pixels in chunk ${r},${u}...`),await g(s,a),await i(500),console.log("AUTOFILL: Finished Intercept"),a.forEach(([e,t])=>o.add(`${r},${u},${e},${t}`)),c(`✅ Placed ${a.length} pixels in chunk (${r},${u})`)}console.log(`AUTOFILL: Completed placing ${b} pixels, starting UI cleanup`),n&&(console.log(`AUTOFILL: Batch completed successfully - ${b} pixels placed`),c(`🎯 Batch complete: ${b} pixels placed`)),console.log("AUTOFILL: Waiting before next cycle"),await i(1e4)}catch(e){console.error("AUTOFILL: Error during auto fill cycle:",e),c(`❌ Error: ${e.message}. Retrying in 10s...`),await i(1e4)}}}).h().I({id:"bm-D",textContent:"Place Now",disabled:!0},(e,t)=>{t.onclick=()=>{"function"==typeof window.bmPlaceNow&&window.bmPlaceNow()}}).h().I({id:"bm-R",textContent:"Mode: Border→Scan",disabled:!0},(e,t)=>{const n=["Border→Scan","Border→Random"];let o=0;t.onclick=()=>{o=(o+1)%n.length,t.textContent=`Mode: ${n[o]}`}}).h().I({id:"bm-J",textContent:"Protect: Off",disabled:!0},(e,t)=>{let n=!1;t.onclick=()=>{if(n=!n,t.textContent="Protect: "+(n?"On":"Off"),e.D("🛡️ Protection mode "+(n?"enabled":"disabled")),window.bmProtectMode=n,n){const t=document.querySelector("#bm-C");t&&"Stop Fill"===t.textContent||e.D("🛡️ Protection enabled - will activate when auto-fill starts")}if(!n){const t=document.querySelector("#bm-C");t&&"Stop Fill"===t.textContent&&(updateAutoFillOutput("🛡️ Protection disabled - stopping auto-fill"),t.click(),e.D("🔄 Auto-fill stopped due to protection disable"))}}}).h().h().U({id:w.i,placeholder:`Status: Sleeping...\nVersion: ${h}`,readOnly:!0}).h().U({id:"bm-B",placeholder:"Auto-Fill Output:\nWaiting for auto-fill to start...",readOnly:!0}).h().U({id:"bm-A",placeholder:"Progress:\nWaiting for template analysis...",readOnly:!0}).h().U({id:"bm-x",placeholder:"Performance:\nCache: 0 hits, 0 misses\nAnalysis time: 0ms",readOnly:!0,style:"height: 60px; font-size: 11px;"}).h().T({id:"bm-1"}).T().I({id:"bm-a",className:"bm-q",innerHTML:"🎨",title:"Template Color Converter"},(e,t)=>{t.addEventListener("click",()=>{window.open("https://pepoafonso.github.io/color_converter_wplace/","_blank","noopener noreferrer")})}).h().h().O({textContent:"Made by SwingTheVine",style:"margin-top: auto;"}).h().h().h().$(document.body),setTimeout(()=>{const e=document.querySelector("#bm-C"),t=document.querySelector("#bm-R"),n=document.querySelector("#bm-J"),o=document.querySelector("#bm-D"),i=document.querySelector("#bm-Q");e&&(w.o?.Ae?.V.length&&w.o?.Ae?.he?(e.disabled=!1,t.disabled=!1,n&&(n.disabled=!1),o&&(o.disabled=!1),i&&(i.disabled=!1)):(e.disabled=!0,t.disabled=!0,n&&(n.disabled=!0),o&&(o.disabled=!0),i&&(i.disabled=!0)))},0)}(),w.R("#bm-n","#bm-i"),$.Ne(w),new MutationObserver((e,t)=>{const n=document.querySelector("#color-1");if(!n)return;let o=document.querySelector("#bm-g");if(!o){o=document.createElement("button"),o.id="bm-g",o.textContent="Move ↑",o.className="btn btn-soft",o.onclick=function(){const e=this.parentNode.parentNode.parentNode.parentNode,t="Move ↑"==this.textContent;e.parentNode.className=e.parentNode.className.replace(t?"bottom":"top",t?"top":"bottom"),e.style.borderTopLeftRadius=t?"0px":"var(--radius-box)",e.style.borderTopRightRadius=t?"0px":"var(--radius-box)",e.style.borderBottomLeftRadius=t?"var(--radius-box)":"0px",e.style.borderBottomRightRadius=t?"var(--radius-box)":"0px",this.textContent=t?"Move ↓":"Move ↑"};const e=n.parentNode.parentNode.parentNode.parentNode.querySelector("h2");e.parentNode?.appendChild(o)}}).observe(document.body,{childList:!0,subtree:!0}),function(...e){(0,console.log)(...e)}(`%c${p}%c (${h}) userscript has loaded!`,"color: cornflowerblue;",""),function(){let e=!1;const t={0:[0,0,0,0],1:[0,0,0,255],2:[60,60,60,255],3:[120,120,120,255],4:[210,210,210,255],5:[255,255,255,255],6:[96,0,24,255],7:[237,28,36,255],8:[255,127,39,255],9:[246,170,9,255],10:[249,221,59,255],11:[255,250,188,255],12:[14,185,104,255],13:[19,230,123,255],14:[135,255,94,255],15:[12,129,110,255],16:[16,174,166,255],17:[19,225,190,255],18:[40,80,158,255],19:[64,147,228,255],20:[96,247,242,255],21:[107,80,246,255],22:[153,177,251,255],23:[120,12,153,255],24:[170,56,185,255],25:[224,159,249,255],26:[203,0,122,255],27:[236,31,128,255],28:[243,141,169,255],29:[104,70,52,255],30:[149,104,42,255],31:[248,178,119,255],32:[170,170,170,255],33:[165,14,30,255],34:[250,128,114,255],35:[228,92,26,255],36:[214,181,148,255],37:[156,132,49,255],38:[197,173,49,255],39:[232,212,95,255],40:[74,107,58,255],41:[90,148,74,255],42:[132,197,115,255],43:[15,121,159,255],44:[187,250,242,255],45:[125,199,255,255],46:[77,49,184,255],47:[74,66,132,255],48:[122,113,196,255],49:[181,174,241,255],50:[219,164,99,255],51:[209,128,81,255],52:[255,197,165,255],53:[155,82,73,255],54:[209,128,120,255],55:[250,182,164,255],56:[123,99,82,255],57:[156,132,107,255],58:[51,57,65,255],59:[109,117,141,255],60:[179,185,209,255],61:[109,100,63,255],62:[148,140,107,255],63:[205,197,158,255]},n=(e,n,o,i)=>{if(0===i)return 0;let s=1/0,a=1;for(const[i,[c,r,l]]of Object.entries(t)){if("0"===i)continue;const t=(e-c)**2+(n-r)**2+(o-l)**2;t<s&&(s=t,a=parseInt(i))}return a},o=async(e,t)=>{try{const n=await fetch(`https://backend.wplace.live/files/s0/tiles/${e}/${t}.png`);if(!n.ok)return null;const o=await n.blob();return await createImageBitmap(o)}catch{return null}},i=async(e,t=!1,n=2e4)=>{const o=Date.now();for(;Date.now()-o<n;){const n=document.querySelector(e);if(n&&(!t||!n.disabled))return n;await new Promise(e=>setTimeout(e,200))}return null};setTimeout(async()=>{if(e)return;e=!0;const t=w?.o?.Ae;if(!t?.V?.length||!t?.he)return;const s=t.V[0];try{await(w?.o?.Se?.())}catch{}const a=w?.o?.charges,c=Math.max(0,Math.floor(a?.count||0));if(c<=0)return;const r=await(async e=>{const t=e?.J;if(!t)return null;const i=Object.keys(t).sort((e,t)=>{const[n,o,i,s]=e.split(",").map(Number),[a,c,r,l]=t.split(",").map(Number);return o!==c?o-c:n!==a?n-a:s!==l?s-l:i-r});for(const e of i){const[i,s,a,c]=e.split(",").map(Number),r=t[e];if(!r)continue;const l=await o(i,s);let u=null;if(l){const e=new OffscreenCanvas(l.width,l.height).getContext("2d");e.drawImage(l,0,0),u=e.getImageData(0,0,l.width,l.height)}const d=new OffscreenCanvas(r.width,r.height).getContext("2d");d.drawImage(r,0,0);const m=d.getImageData(0,0,r.width,r.height),p=[];for(let e=1;e<r.height;e+=3)for(let t=1;t<r.width;t+=3){const o=4*(e*r.width+t),i=m.data[o+3];if(0===i)continue;const s=m.data[o],l=m.data[o+1],d=m.data[o+2],h=n(s,l,d,i),f=a+Math.floor((t-1)/3),b=c+Math.floor((e-1)/3);if(u&&f>=0&&f<u.width&&b>=0&&b<u.height){const e=4*(b*u.width+f),t=u.data[e],o=u.data[e+1],i=u.data[e+2],s=u.data[e+3];if(n(t,o,i,s)===h)continue}p.push([f,b,h])}if(p.length)return p.sort((e,t)=>e[1]-t[1]||e[0]-t[0]),{tt:[i,s],nt:p}}return null})(s);if(!r)return;const[l,u]=r.tt;r.nt.length>c&&(r.nt=r.nt.slice(0,c)),console.log(`AUTOLOAD: Placing ${r.nt.length} pixels (<= ${c} charges) in one request for chunk (${l},${u})`);try{await(async(e,t,n)=>{if(!n?.length)return;const o=unsafeWindow.fetch;let s=!0;return new Promise(async(a,c)=>{unsafeWindow.fetch=async(...i)=>{const r=i[0],l=i[1]||{},u=(l.method||"GET").toUpperCase();if(!s)return o.apply(unsafeWindow,i);if("POST"===u&&"string"==typeof r&&r.includes("/pixel/"))try{const i=JSON.parse(l.body).t,{st:c,ct:r}=((o,i)=>({st:{colors:n.map(([,,e])=>e),coords:n.flatMap(([e,t])=>[e,t]),t:i},ct:`https://backend.wplace.live/s0/pixel/${e}/${t}`}))(0,i);s=!1,unsafeWindow.fetch=o;const u=await o.call(unsafeWindow,r,{...l,body:JSON.stringify(c)});return a(u),u}catch(e){s=!1,unsafeWindow.fetch=o,c(e)}return o.apply(unsafeWindow,i)};try{await(async()=>{const e=await i(".btn.btn-primary.btn-lg.sm\\:btn-xl.relative.z-30",!0,2e4);if(!e)throw new Error("Paint button not found");e.click(),await new Promise(e=>setTimeout(e,300));const t=document.querySelector(".maplibregl-canvas");if(!t)throw new Error("Map canvas not found");const n=Math.floor(window.innerWidth/2),o=Math.floor(window.innerHeight/2);for(const e of["mousedown","click","mouseup"]){const i=new MouseEvent(e,{clientX:n,clientY:o,bubbles:!0});t.dispatchEvent(i),await new Promise(e=>setTimeout(e,50))}const s=await i(".btn.btn-primary.btn-lg.sm\\:btn-xl.relative",!0,2e4);if(!s)throw new Error("Final button not found");s.click()})()}catch(e){unsafeWindow.fetch=o,c(e)}})})(l,u,r.nt),console.log("AUTOLOAD: Placement request sent")}catch(e){console.error("AUTOLOAD: Placement failed",e)}},5e3)}()})();